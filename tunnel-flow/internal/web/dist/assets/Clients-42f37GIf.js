import{E as v,p as he,r as be,u as Ce,m as G,w as ke,c as W,d as we,v as xe,g as Ve,h as Se,j as X,k as Z}from"./elementPlus-DsCZj5OD.js";import{u as $e,a as ze}from"./routes-C4LADMu3.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as g,c as Be,h as Fe,j as Ue,z as b,A as y,B as s,R as t,J as l,al as p,u as i,P as c,K as Ie,ar as Te,I as Y,O as r,L as N,Q as Ee,a6 as Pe}from"./vendor-CVfcT1hl.js";import"./index-CCZm0Y1N.js";const Me={class:"clients-page"},Re={class:"page-header"},Le={class:"header-right"},Ne={class:"stats-container"},Ae={class:"stat-icon total"},je={class:"stat-content"},qe={class:"stat-value"},Qe={class:"stat-icon online"},Ye={class:"stat-content"},He={class:"stat-value"},Je={class:"stat-icon offline"},Ke={class:"stat-content"},Oe={class:"stat-value"},Ge={class:"stat-icon enabled"},We={class:"stat-content"},Xe={class:"stat-value"},Ze={class:"stat-icon disabled"},et={class:"stat-content"},tt={class:"stat-value"},lt={class:"search-section"},at={class:"search-left"},st={class:"table-container"},nt={class:"client-name"},ot={style:{"font-weight":"500"}},it=["title"],dt={class:"action-buttons"},ut={class:"pagination-container"},rt={key:0,class:"client-detail"},ct={key:0},pt={key:1,style:{color:"#909399"}},_t={key:0,class:"token-section",style:{"margin-top":"20px"}},vt={key:0,class:"token-display"},ft={key:1,class:"client-routes"},mt={class:"dialog-footer"},gt={class:"success-content"},yt={class:"success-icon"},ht={class:"token-section"},bt={style:{"text-align":"center","margin-top":"20px"}},Ct={class:"dialog-footer"},kt={__name:"Clients",setup(wt){const d=$e(),A=ze(),F=g(""),U=g(""),I=g(!1),u=g(null),T=g([]),S=g(!1),k=g(!1),j=g(!1),E=g(null),m=g({id:"",name:"",description:""}),P=g(!1),w=g({client_id:"",auth_token:""}),ee={name:[{required:!0,message:"请输入客户端名称",trigger:"blur"}]},te=Be(()=>{let n=d.clients;if(F.value){const e=F.value.toLowerCase();n=n.filter(o=>o.name&&o.name.toLowerCase().includes(e)||o.client_id.toLowerCase().includes(e))}return n}),M=n=>{if(!n)return"";let e;if(typeof n=="number"){if(n<=86400)return"";e=new Date(n<1e10?n*1e3:n)}else e=new Date(n);if(isNaN(e.getTime())||e.getFullYear()<=1970&&e.getMonth()===0&&e.getDate()===1)return"";const o=e.getFullYear(),_=String(e.getMonth()+1).padStart(2,"0"),x=String(e.getDate()).padStart(2,"0"),f=String(e.getHours()).padStart(2,"0"),C=String(e.getMinutes()).padStart(2,"0"),q=String(e.getSeconds()).padStart(2,"0");return`${o}-${_}-${x} ${f}:${C}:${q}`},$=async()=>{try{await Promise.all([d.fetchClients(),A.fetchRoutes()]),v.success("数据已刷新")}catch{v.error("刷新数据失败")}},le=()=>{},ae=async()=>{await d.fetchClientsByStatus(U.value)},z=async n=>{U.value=n,await d.fetchClientsByStatus(n)},se=n=>{d.setPageSize(n)},ne=n=>{d.setPage(n)},oe=async n=>{u.value=n,T.value=A.routesByClient[n.client_id]||[],I.value=!0},ie=async n=>{try{await navigator.clipboard.writeText(n),v.success("认证令牌已复制到剪贴板")}catch{const o=document.createElement("textarea");o.value=n,document.body.appendChild(o),o.select(),document.execCommand("copy"),document.body.removeChild(o),v.success("认证令牌已复制到剪贴板")}},de=async n=>{try{await Z.confirm(`确定要删除客户端 "${n.name||n.client_id}" 吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await d.deleteClient(n.client_id),v.success("客户端已删除")}catch(e){e!=="cancel"&&v.error("删除客户端失败")}},ue=async(n,e)=>{var _,x;const o=e?"启用":"禁用";try{await Z.confirm(`确定要${o}客户端 "${n.name||n.client_id}" 吗？`,`${o}客户端`,{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await d.updateClientEnabled(n.client_id,e),v.success(`客户端${o}成功`),await $()}catch(f){if(f!=="cancel"){const C=((x=(_=f.response)==null?void 0:_.data)==null?void 0:x.message)||f.message||`客户端${o}失败`;v.error(C),console.error(`Failed to ${o} client:`,f)}}},re=()=>{I.value=!1,u.value=null,T.value=[]},ce=()=>{k.value=!1,m.value={id:"",name:"",description:""},S.value=!0},pe=n=>{k.value=!0,m.value={id:n.client_id,name:n.name||"",description:n.description||""},S.value=!0},D=()=>{var n;S.value=!1,(n=E.value)==null||n.resetFields()},_e=()=>{P.value=!1,w.value={client_id:"",auth_token:""}},ve=async()=>{const n=`客户端编码: ${w.value.client_id}
认证令牌: ${w.value.auth_token}`;try{await navigator.clipboard.writeText(n),v.success("全部信息已复制到剪贴板")}catch{const o=document.createElement("textarea");o.value=n,document.body.appendChild(o),o.select();try{document.execCommand("copy"),v.success("全部信息已复制到剪贴板")}catch{v.error("复制失败，请手动复制")}document.body.removeChild(o)}},fe=async()=>{if(E.value)try{if(await E.value.validate(),j.value=!0,k.value)await d.updateClient(m.value.id,{name:m.value.name,description:m.value.description}),v.success("客户端更新成功"),D(),await $();else{const n={name:m.value.name,description:m.value.description},e=await d.createClient(n);e&&e.auth_token?(w.value={client_id:e.client_id,auth_token:e.auth_token},D(),P.value=!0):(v.success("客户端创建成功"),D()),await $()}}catch(n){n!=="validation failed"&&v.error(k.value?"更新客户端失败":"创建客户端失败")}finally{j.value=!1}};return Fe(async()=>{await $()}),Ue(()=>A.routes,()=>{},{deep:!0}),(n,e)=>{const o=p("el-icon"),_=p("el-button"),x=p("Close"),f=p("el-input"),C=p("el-option"),q=p("el-select"),h=p("el-table-column"),B=p("el-tag"),me=p("el-switch"),H=p("el-table"),ge=p("el-pagination"),V=p("el-descriptions-item"),J=p("el-descriptions"),K=p("el-alert"),Q=p("el-dialog"),R=p("el-form-item"),O=p("el-form"),ye=Te("loading");return y(),b("div",Me,[s("div",Re,[e[18]||(e[18]=s("div",{class:"header-left"},[s("h1",{class:"page-title"},"客户端管理"),s("p",{class:"page-description"},"管理和监控所有连接的客户端")],-1)),s("div",Le,[t(_,{type:"primary",onClick:ce},{default:l(()=>[t(o,null,{default:l(()=>[t(i(he))]),_:1}),e[16]||(e[16]=r(" 新增客户端 ",-1))]),_:1}),t(_,{type:"primary",onClick:$,loading:i(d).loading},{default:l(()=>[t(o,null,{default:l(()=>[t(i(be))]),_:1}),e[17]||(e[17]=r(" 刷新 ",-1))]),_:1},8,["loading"])])]),s("div",Ne,[s("div",{class:"stat-card total-card",onClick:e[0]||(e[0]=a=>z(""))},[s("div",Ae,[t(o,null,{default:l(()=>[t(i(Ce))]),_:1})]),s("div",je,[s("div",qe,c(i(d).clientsStats.total),1),e[19]||(e[19]=s("div",{class:"stat-label"},"总客户端",-1))])]),s("div",{class:"stat-card online-card",onClick:e[1]||(e[1]=a=>z("online"))},[s("div",Qe,[t(o,null,{default:l(()=>[t(i(G))]),_:1})]),s("div",Ye,[s("div",He,c(i(d).clientsStats.online),1),e[20]||(e[20]=s("div",{class:"stat-label"},"在线客户端",-1))])]),s("div",{class:"stat-card offline-card",onClick:e[2]||(e[2]=a=>z("offline"))},[s("div",Je,[t(o,null,{default:l(()=>[t(i(ke))]),_:1})]),s("div",Ke,[s("div",Oe,c(i(d).clientsStats.offline),1),e[21]||(e[21]=s("div",{class:"stat-label"},"离线客户端",-1))])]),s("div",{class:"stat-card enabled-card",onClick:e[3]||(e[3]=a=>z("enabled"))},[s("div",Ge,[t(o,null,{default:l(()=>[t(i(W))]),_:1})]),s("div",We,[s("div",Xe,c(i(d).clientsStats.enabled),1),e[22]||(e[22]=s("div",{class:"stat-label"},"已启用客户端",-1))])]),s("div",{class:"stat-card disabled-card",onClick:e[4]||(e[4]=a=>z("disabled"))},[s("div",Ze,[t(o,null,{default:l(()=>[t(x)]),_:1})]),s("div",et,[s("div",tt,c(i(d).clientsStats.disabled),1),e[23]||(e[23]=s("div",{class:"stat-label"},"已停用客户端",-1))])])]),s("div",lt,[s("div",at,[t(f,{modelValue:F.value,"onUpdate:modelValue":e[5]||(e[5]=a=>F.value=a),placeholder:"搜索客户端名称",style:{width:"300px"},clearable:"",onInput:le},{prefix:l(()=>[t(o,null,{default:l(()=>[t(i(we))]),_:1})]),_:1},8,["modelValue"]),t(q,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=a=>U.value=a),placeholder:"状态筛选",style:{width:"120px"},clearable:"",onChange:ae},{default:l(()=>[t(C,{label:"在线",value:"online"}),t(C,{label:"离线",value:"offline"}),t(C,{label:"启用",value:"enabled"}),t(C,{label:"停用",value:"disabled"})]),_:1},8,["modelValue"])]),e[24]||(e[24]=s("div",{class:"search-right"},null,-1))]),s("div",st,[Ie((y(),Y(H,{data:te.value,stripe:"",style:{width:"100%"}},{default:l(()=>[t(h,{label:"客户端名称","min-width":"200"},{default:l(({row:a})=>[s("div",nt,[t(o,{class:"client-icon"},{default:l(()=>[t(i(G))]),_:1}),s("div",null,[s("div",ot,c(a.name||"未命名"),1),a.description?(y(),b("div",{key:0,class:"description-line",title:a.description},c(a.description),9,it)):N("",!0)])])]),_:1}),t(h,{label:"客户端编码",prop:"client_id","min-width":"220","show-overflow-tooltip":""}),t(h,{label:"状态",width:"100",align:"center"},{default:l(({row:a})=>[t(B,{type:a.status==="online"?"success":a.status==="disabled"?"info":"danger",size:"small"},{default:l(()=>[r(c(a.status==="online"?"在线":a.status==="disabled"?"已禁用":"离线"),1)]),_:2},1032,["type"])]),_:1}),t(h,{label:"本地IP","min-width":"140","show-overflow-tooltip":""},{default:l(({row:a})=>[r(c(a.local_ips&&a.local_ips.length>0?a.local_ips.join(", "):"-"),1)]),_:1}),t(h,{label:"创建时间",width:"160"},{default:l(({row:a})=>[r(c(M(a.created_at)),1)]),_:1}),t(h,{label:"最新心跳时间",width:"160"},{default:l(({row:a})=>[r(c(M(a.last_seen_ts)||"-"),1)]),_:1}),t(h,{label:"启用状态",width:"120",align:"center"},{default:l(({row:a})=>[t(me,{"model-value":a.enabled===1,onChange:L=>ue(a,L),"active-text":"启用","inactive-text":"禁用","inline-prompt":"",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["model-value","onChange"])]),_:1}),t(h,{label:"操作",width:"240",fixed:"right"},{default:l(({row:a})=>[s("div",dt,[t(_,{size:"small",onClick:L=>oe(a)},{default:l(()=>[t(o,null,{default:l(()=>[t(i(xe))]),_:1}),e[25]||(e[25]=r(" 详情 ",-1))]),_:1},8,["onClick"]),t(_,{size:"small",type:"primary",onClick:L=>pe(a)},{default:l(()=>[t(o,null,{default:l(()=>[t(i(Ve))]),_:1}),e[26]||(e[26]=r(" 编辑 ",-1))]),_:1},8,["onClick"]),t(_,{size:"small",type:"danger",onClick:L=>de(a)},{default:l(()=>[t(o,null,{default:l(()=>[t(i(Se))]),_:1}),e[27]||(e[27]=r(" 删除 ",-1))]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),[[ye,i(d).loading]]),s("div",ut,[t(ge,{"current-page":i(d).pagination.page,"onUpdate:currentPage":e[7]||(e[7]=a=>i(d).pagination.page=a),"page-size":i(d).pagination.pageSize,"onUpdate:pageSize":e[8]||(e[8]=a=>i(d).pagination.pageSize=a),"page-sizes":[10,20,50,100],total:i(d).pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:se,onCurrentChange:ne},null,8,["current-page","page-size","total"])])]),t(Q,{modelValue:I.value,"onUpdate:modelValue":e[11]||(e[11]=a=>I.value=a),title:"客户端详情",width:"800px","before-close":re},{default:l(()=>[u.value?(y(),b("div",rt,[t(J,{column:2,border:""},{default:l(()=>[t(V,{label:"客户端ID"},{default:l(()=>[t(B,null,{default:l(()=>[r(c(u.value.client_id),1)]),_:1})]),_:1}),t(V,{label:"客户端名称"},{default:l(()=>[r(c(u.value.name||"未设置"),1)]),_:1}),t(V,{label:"状态"},{default:l(()=>[t(B,{type:u.value.status==="online"?"success":u.value.status==="disabled"?"info":"danger"},{default:l(()=>[r(c(u.value.status==="online"?"在线":u.value.status==="disabled"?"已禁用":"离线"),1)]),_:1},8,["type"])]),_:1}),t(V,{label:"本地IP地址",span:"2"},{default:l(()=>[u.value.local_ips&&u.value.local_ips.length>0?(y(),b("div",ct,[(y(!0),b(Ee,null,Pe(u.value.local_ips,a=>(y(),Y(B,{key:a,style:{"margin-right":"8px","margin-bottom":"4px"}},{default:l(()=>[r(c(a),1)]),_:2},1024))),128))])):(y(),b("span",pt,"未获取到本地IP地址"))]),_:1})]),_:1}),u.value.has_auth_token||u.value.auth_token?(y(),b("div",_t,[e[29]||(e[29]=s("h4",{style:{"margin-bottom":"10px"}},"认证令牌",-1)),u.value.auth_token?(y(),b("div",vt,[t(f,{modelValue:u.value.auth_token,"onUpdate:modelValue":e[10]||(e[10]=a=>u.value.auth_token=a),readonly:"",type:"textarea",rows:2,style:{"margin-bottom":"10px"}},{append:l(()=>[t(_,{onClick:e[9]||(e[9]=a=>ie(u.value.auth_token)),icon:i(X)},{default:l(()=>[...e[28]||(e[28]=[r(" 复制 ",-1)])]),_:1},8,["icon"])]),_:1},8,["modelValue"]),t(K,{title:"认证令牌",type:"info",description:"请妥善保管此令牌，客户端连接时需要使用。",closable:!1,"show-icon":""})])):(y(),Y(K,{key:1,title:"认证令牌已配置",type:"success",description:"该客户端已配置认证令牌，出于安全考虑不显示具体内容。如需重新生成，请删除并重新创建客户端。",closable:!1,"show-icon":""}))])):N("",!0),t(J,{column:2,border:"",style:{"margin-top":"20px"}},{default:l(()=>[t(V,{label:"创建时间"},{default:l(()=>[r(c(M(u.value.created_at)||"-"),1)]),_:1}),t(V,{label:"最新心跳时间"},{default:l(()=>[r(c(M(u.value.last_seen_ts||u.value.last_seen)||"-"),1)]),_:1})]),_:1}),T.value.length>0?(y(),b("div",ft,[e[30]||(e[30]=s("h3",null,"关联路由",-1)),t(H,{data:T.value,size:"small"},{default:l(()=>[t(h,{prop:"server_path",label:"服务器路径"}),t(h,{prop:"target_url",label:"目标地址"}),t(h,{prop:"status",label:"状态"},{default:l(({row:a})=>[t(B,{type:a.status==="active"?"success":"info",size:"small"},{default:l(()=>[r(c(a.status==="active"?"活跃":"非活跃"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):N("",!0)])):N("",!0)]),_:1},8,["modelValue"]),t(Q,{modelValue:S.value,"onUpdate:modelValue":e[14]||(e[14]=a=>S.value=a),title:k.value?"编辑客户端":"新增客户端",width:"500px",onClose:D},{footer:l(()=>[s("div",mt,[t(_,{onClick:D},{default:l(()=>[...e[31]||(e[31]=[r("取消",-1)])]),_:1}),t(_,{type:"primary",onClick:fe,loading:j.value},{default:l(()=>[r(c(k.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:l(()=>[t(O,{ref_key:"formRef",ref:E,model:m.value,rules:ee,"label-width":"100px"},{default:l(()=>[t(R,{label:"客户端名称",prop:"name"},{default:l(()=>[t(f,{modelValue:m.value.name,"onUpdate:modelValue":e[12]||(e[12]=a=>m.value.name=a),placeholder:"请输入客户端名称"},null,8,["modelValue"])]),_:1}),t(R,{label:"描述",prop:"description"},{default:l(()=>[t(f,{modelValue:m.value.description,"onUpdate:modelValue":e[13]||(e[13]=a=>m.value.description=a),type:"textarea",rows:3,placeholder:"请输入客户端描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(Q,{modelValue:P.value,"onUpdate:modelValue":e[15]||(e[15]=a=>P.value=a),title:"客户端创建成功",width:"600px","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:l(()=>[s("div",Ct,[t(_,{type:"primary",onClick:_e},{default:l(()=>[...e[35]||(e[35]=[r(" 确定 ",-1)])]),_:1})])]),default:l(()=>[s("div",gt,[s("div",yt,[t(o,{size:"48",color:"#67c23a"},{default:l(()=>[t(i(W))]),_:1})]),e[33]||(e[33]=s("h3",null,"客户端创建成功！",-1)),e[34]||(e[34]=s("p",null,"请保存以下认证令牌，并配置到客户端：",-1)),s("div",ht,[t(O,{"label-width":"120px"},{default:l(()=>[t(R,{label:"客户端编码:"},{default:l(()=>[t(f,{value:w.value.client_id,readonly:"",class:"readonly-input"},null,8,["value"])]),_:1}),t(R,{label:"认证令牌:"},{default:l(()=>[t(f,{value:w.value.auth_token,readonly:"",type:"textarea",rows:3,class:"readonly-input token-input"},null,8,["value"])]),_:1})]),_:1}),s("div",bt,[t(_,{type:"primary",onClick:ve},{default:l(()=>[t(o,null,{default:l(()=>[t(i(X))]),_:1}),e[32]||(e[32]=r(" 复制全部信息 ",-1))]),_:1})])])])]),_:1},8,["modelValue"])])}}},Dt=De(kt,[["__scopeId","data-v-e62825e8"]]);export{Dt as default};

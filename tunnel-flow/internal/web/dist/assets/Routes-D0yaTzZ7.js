import{E as f,k as O,p as $e,r as Ue,l as Z,n as ee,w as te,d as ze,o as ke,h as le,q as Te,g as Be}from"./elementPlus-DsCZj5OD.js";import{a as De,u as je}from"./routes-C4LADMu3.js";import{a as F}from"./index-CCZm0Y1N.js";import{_ as Ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as w,c as D,h as Le,z as x,A as h,B as a,L as q,R as l,J as n,al as b,P as d,K as Fe,ar as Pe,u,I as ae,Q as Ne,a6 as Ie,O as r}from"./vendor-CVfcT1hl.js";const Ae={class:"routes-page"},Me={class:"client-selection"},Oe={class:"client-selector-row"},qe={class:"client-selector"},He={class:"client-option"},Je={class:"client-status-info"},Qe={class:"client-actions"},Ye={key:0,class:"stats-cards"},Ke={class:"stat-card"},Ge={class:"stat-icon active"},We={class:"stat-content"},Xe={class:"stat-value"},Ze={class:"stat-card"},et={class:"stat-icon total"},tt={class:"stat-content"},lt={class:"stat-value"},at={class:"stat-card"},st={class:"stat-icon inactive"},nt={class:"stat-content"},ot={class:"stat-value"},rt={key:1,class:"search-section"},it={class:"search-left"},ut={class:"search-right"},dt={key:2,class:"table-container"},pt={class:"route-path"},ft={class:"path-content"},vt={class:"path-text"},ct=["title"],gt={class:"target-url"},_t={class:"target-text"},mt={class:"action-buttons"},bt={class:"pagination-container"},yt={key:3,class:"no-client-selected"},wt={class:"form-tip"},ht={class:"form-tip"},xt={key:0},Ct={key:1},Vt={class:"dialog-footer"},St={__name:"Routes",setup(Rt){const m=De(),P=je(),g=w(""),z=w(""),S=w(""),j=w(""),v=w([]),k=w([]),R=w(!1),$=w(!1),N=w(!1),T=w(),I=w({base_url:window.location.origin,proxy_url:null}),p=w({url_suffix:"",targets_json:"",client_id:"",strategy:"first_available",route_mode:"basic",enabled:!0,description:""}),se={url_suffix:[{required:!0,message:"请输入服务器路径",trigger:"blur"},{pattern:/^\//,message:"路径必须以 / 开头",trigger:"blur"},{validator:(t,e,o)=>{if(e&&e.includes("*")&&e.split("*").length>5){o(new Error("通配符使用过多，请简化路径模式"));return}o()},trigger:"blur"}],targets_json:[{required:!0,message:"请输入目标地址",trigger:"blur"},{validator:(t,e,o)=>{if(!e||e.trim()===""){o(new Error("请输入目标地址"));return}const _=p.value.route_mode,y=e.trim();if(_==="basic"){if(y.match(/^https?:\/\/[^\/]+:\d+\/?$/)){o();return}}else if(y.match(/^https?:\/\/.+/)){o();return}try{const i=JSON.parse(e);if(Array.isArray(i)&&i.length>0){for(const c of i){if(!c.url){o(new Error("每个目标必须包含url字段"));return}if(_==="basic"){if(!c.url.match(/^https?:\/\/[^\/]+:\d+\/?$/)){o(new Error("基础模式下目标地址格式应为: http://ip:port"));return}}else if(!c.url.match(/^https?:\/\/.+/)){o(new Error("完整模式下目标地址必须是有效的HTTP(S) URL"));return}}o();return}}catch{}o(_==="basic"?new Error("基础模式下目标地址格式应为: http://ip:port"):new Error("完整模式下目标地址必须是有效的HTTP(S) URL"))},trigger:"blur"}]},A=D(()=>I.value.proxy_url||I.value.base_url),H=D(()=>P.clients||[]),B=D(()=>H.value.find(t=>t.client_id===g.value)),M=D(()=>{const t=k.value;return{total:t.length,active:t.filter(e=>e.enabled===1).length,inactive:t.filter(e=>e.enabled===0).length}}),ne=D(()=>{let t=k.value;if(S.value&&(S.value==="enabled"?t=t.filter(e=>e.enabled===1):S.value==="disabled"&&(t=t.filter(e=>e.enabled===0))),j.value&&(t=t.filter(e=>e.route_mode===j.value)),z.value){const e=z.value.toLowerCase();t=t.filter(o=>o.url_suffix.toLowerCase().includes(e)||Y(o.targets_json).toLowerCase().includes(e)||o.description&&o.description.toLowerCase().includes(e))}return t}),J=t=>{if(!t)return"";let e;if(typeof t=="number"){if(t<=86400)return"";e=new Date(t<1e10?t*1e3:t)}else e=new Date(t);if(isNaN(e.getTime())||e.getFullYear()<=1970&&e.getMonth()===0&&e.getDate()===1)return"";const o=e.getFullYear(),_=String(e.getMonth()+1).padStart(2,"0"),y=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),c=String(e.getMinutes()).padStart(2,"0"),V=String(e.getSeconds()).padStart(2,"0");return`${o}-${_}-${y} ${i}:${c}:${V}`},oe=()=>B.value?B.value.name||B.value.client_id:"",Q=()=>B.value?B.value.status:"offline",Y=t=>{if(!t)return"-";try{const e=JSON.parse(t);return Array.isArray(e)&&e.length>0?e.length===1?e[0].url:`${e[0].url} (+${e.length-1}个)`:"-"}catch{return t}},re=async t=>{t?await E(t):k.value=[],z.value="",S.value="",v.value=[]},ie=async()=>{try{const t=await F.get("/server-info");t.data&&(I.value={base_url:t.data.base_url||window.location.origin,proxy_url:t.data.proxy_url||null})}catch(t){console.error("获取服务器信息失败:",t)}},E=async t=>{try{m.loading=!0;const e=await F.get(`/routes?client_id=${t}`);k.value=e.data||[]}catch(e){console.error("加载客户端路由失败:",e),f.error("加载客户端路由失败"),k.value=[]}finally{m.loading=!1}},ue=async()=>{try{await P.fetchClients(),g.value&&await E(g.value),f.success("数据已刷新")}catch{f.error("刷新数据失败")}},de=()=>{},K=()=>{},pe=t=>{v.value=t},fe=t=>{m.setPageSize(t)},ve=t=>{m.setPage(t)},ce=()=>{if(!g.value){f.warning("请先选择客户端");return}$.value=!1,p.value={url_suffix:"",targets_json:"",client_id:g.value,strategy:"first_available",route_mode:"basic",enabled:!0,description:""},R.value=!0},ge=t=>{$.value=!0;let e=t.targets_json;try{const o=JSON.parse(t.targets_json);Array.isArray(o)&&o.length>0&&o[0].url&&(e=o[0].url)}catch{e=t.targets_json}p.value={id:t.id,url_suffix:t.url_suffix,targets_json:e,client_id:t.client_id,route_mode:t.route_mode||"basic",enabled:t.enabled===1,description:t.description||""},R.value=!0},_e=async()=>{if(T.value)try{await T.value.validate(),N.value=!0;const t={...p.value};t.enabled=t.enabled?1:0,$.value?(await m.updateRoute(t.id,t),f.success("路由更新成功")):(await m.createRoute(t),f.success("路由创建成功")),R.value=!1,g.value&&await E(g.value)}catch(t){t!=="validation failed"&&f.error($.value?"路由更新失败":"路由创建失败")}finally{N.value=!1}},me=async t=>{try{await O.confirm(`确定要删除路由 "${t.server_path}" 吗？此操作不可恢复。`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await m.deleteRoute(t.id),f.success("路由已删除"),g.value&&await E(g.value)}catch(e){e!=="cancel"&&f.error("删除路由失败")}},be=async()=>{try{await O.confirm(`确定要删除选中的 ${v.value.length} 个路由吗？此操作不可恢复。`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=v.value.map(e=>m.deleteRoute(e.id));await Promise.all(t),f.success("批量删除成功"),v.value=[]}catch(t){t!=="cancel"&&f.error("批量删除失败")}},G=()=>{R.value=!1,T.value&&T.value.resetFields()},ye=async t=>{try{const e=`${A.value}${t}`;await navigator.clipboard.writeText(e),f.success("路径已复制到剪贴板")}catch{f.error("复制失败")}},we=async(t,e)=>{try{t.toggling=!0;const o=await F.put(`/routes/${t.id}/enabled`,{enabled:e});(o.status===204||o.status===200)&&(t.enabled=e?1:0,f.success(e?"路由已启用":"路由已禁用"))}catch(o){console.error("切换路由状态失败:",o),f.error("操作失败")}finally{t.toggling=!1}},W=async t=>{if(v.value.length===0){f.warning("请先选择要操作的路由");return}try{const e=t?"启用":"禁用";await O.confirm(`确定要${e}选中的 ${v.value.length} 个路由吗？`,`批量${e}路由`,{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const o=v.value.map(y=>y.id);(await F.put("/routes/batch/enabled",{route_ids:o,enabled:t})).data&&(v.value.forEach(y=>{y.enabled=t?1:0}),f.success(`成功${e}了 ${v.value.length} 个路由`),v.value=[])}catch(e){e!=="cancel"&&(console.error("批量操作失败:",e),f.error("批量操作失败"))}};return Le(async()=>{await ie(),await P.fetchClients()}),(t,e)=>{const o=b("el-tag"),_=b("el-option"),y=b("el-select"),i=b("el-icon"),c=b("el-button"),V=b("el-input"),C=b("el-table-column"),X=b("el-switch"),he=b("el-table"),xe=b("el-pagination"),Ce=b("el-empty"),U=b("el-form-item"),Ve=b("el-form"),Se=b("el-dialog"),Re=Pe("loading");return h(),x("div",Ae,[e[54]||(e[54]=a("div",{class:"page-header"},[a("div",{class:"page-info"},[a("h1",{class:"page-title"},"路由管理"),a("p",{class:"page-description"},"选择客户端后管理其路由配置，设置请求转发规则")])],-1)),a("div",Me,[e[16]||(e[16]=a("div",{class:"selection-header"},[a("h3",null,"选择客户端"),a("p",null,"请先选择要管理路由的客户端")],-1)),a("div",Oe,[a("div",qe,[l(y,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=s=>g.value=s),placeholder:"请选择客户端",style:{width:"300px"},onChange:re,clearable:"",filterable:"","filter-placeholder":"搜索客户端名称..."},{default:n(()=>[(h(!0),x(Ne,null,Ie(H.value,s=>(h(),ae(_,{key:s.client_id,label:`${s.name||s.client_id} (${s.status==="online"?"在线":"离线"})`,value:s.client_id,disabled:s.status!=="online"&&s.enabled!==1},{default:n(()=>[a("div",He,[a("span",null,d(s.name||s.client_id),1),a("div",Je,[l(o,{type:s.status==="online"?"success":s.enabled===1?"warning":"danger",size:"small"},{default:n(()=>[r(d(s.status==="online"?"在线":"离线"),1)]),_:2},1032,["type"])])])]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),a("div",Qe,[l(c,{type:"primary",onClick:ce,disabled:!g.value},{default:n(()=>[l(i,null,{default:n(()=>[l(u($e))]),_:1}),e[14]||(e[14]=r(" 新建路由 ",-1))]),_:1},8,["disabled"]),l(c,{onClick:ue},{default:n(()=>[l(i,null,{default:n(()=>[l(u(Ue))]),_:1}),e[15]||(e[15]=r(" 刷新 ",-1))]),_:1})])])]),g.value?(h(),x("div",Ye,[a("div",Ke,[a("div",Ge,[l(i,null,{default:n(()=>[l(u(Z))]),_:1})]),a("div",We,[a("div",Xe,d(M.value.active),1),e[17]||(e[17]=a("div",{class:"stat-label"},"活跃路由",-1))])]),a("div",Ze,[a("div",et,[l(i,null,{default:n(()=>[l(u(ee))]),_:1})]),a("div",tt,[a("div",lt,d(M.value.total),1),e[18]||(e[18]=a("div",{class:"stat-label"},"总路由",-1))])]),a("div",at,[a("div",st,[l(i,null,{default:n(()=>[l(u(te))]),_:1})]),a("div",nt,[a("div",ot,d(M.value.inactive),1),e[19]||(e[19]=a("div",{class:"stat-label"},"非活跃路由",-1))])])])):q("",!0),g.value?(h(),x("div",rt,[a("div",it,[l(V,{modelValue:z.value,"onUpdate:modelValue":e[1]||(e[1]=s=>z.value=s),placeholder:"搜索路由路径或目标地址",style:{width:"300px"},clearable:"",onInput:de},{prefix:n(()=>[l(i,null,{default:n(()=>[l(u(ze))]),_:1})]),_:1},8,["modelValue"]),l(y,{modelValue:S.value,"onUpdate:modelValue":e[2]||(e[2]=s=>S.value=s),placeholder:"状态筛选",style:{width:"120px"},clearable:"",onChange:K},{default:n(()=>[l(_,{label:"已启用",value:"enabled"}),l(_,{label:"已禁用",value:"disabled"})]),_:1},8,["modelValue"]),l(y,{modelValue:j.value,"onUpdate:modelValue":e[3]||(e[3]=s=>j.value=s),placeholder:"模式筛选",style:{width:"120px"},clearable:"",onChange:K},{default:n(()=>[l(_,{label:"基础模式",value:"basic"}),l(_,{label:"完整模式",value:"full"})]),_:1},8,["modelValue"])]),a("div",ut,[l(c,{type:"success",disabled:v.value.length===0,onClick:e[4]||(e[4]=s=>W(!0))},{default:n(()=>[l(i,null,{default:n(()=>[l(u(ke))]),_:1}),r(" 批量启用 ("+d(v.value.length)+") ",1)]),_:1},8,["disabled"]),l(c,{type:"warning",disabled:v.value.length===0,onClick:e[5]||(e[5]=s=>W(!1))},{default:n(()=>[l(i,null,{default:n(()=>[l(u(te))]),_:1}),r(" 批量禁用 ("+d(v.value.length)+") ",1)]),_:1},8,["disabled"]),l(c,{type:"danger",disabled:v.value.length===0,onClick:be},{default:n(()=>[l(i,null,{default:n(()=>[l(u(le))]),_:1}),r(" 批量删除 ("+d(v.value.length)+") ",1)]),_:1},8,["disabled"])])])):q("",!0),g.value?(h(),x("div",dt,[Fe((h(),ae(he,{data:ne.value,onSelectionChange:pe,stripe:"",style:{width:"100%"}},{default:n(()=>[l(C,{type:"selection",width:"55"}),l(C,{prop:"url_suffix",label:"服务器路径","min-width":"250"},{default:n(({row:s})=>[a("div",pt,[l(i,{class:"path-icon"},{default:n(()=>[l(u(Z))]),_:1}),a("div",ft,[a("div",vt,d(s.url_suffix),1),s.description?(h(),x("div",{key:0,class:"description-line",title:s.description},d(s.description),9,ct)):q("",!0)]),l(c,{type:"primary",link:"",size:"small",onClick:L=>ye(s.url_suffix)},{default:n(()=>[l(i,null,{default:n(()=>[l(u(Te))]),_:1})]),_:1},8,["onClick"])])]),_:1}),l(C,{prop:"targets_json",label:"目标地址","min-width":"220"},{default:n(({row:s})=>[a("div",gt,[a("span",_t,d(Y(s.targets_json)),1)])]),_:1}),l(C,{prop:"route_mode",label:"路由模式",width:"110"},{default:n(({row:s})=>[l(o,{type:s.route_mode==="full"?"primary":"success",size:"small"},{default:n(()=>[r(d(s.route_mode==="full"?"完整模式":"基础模式"),1)]),_:2},1032,["type"])]),_:1}),l(C,{prop:"enabled",label:"启用状态",width:"100"},{default:n(({row:s})=>[l(X,{"model-value":s.enabled===1,onChange:L=>we(s,L),loading:s.toggling},null,8,["model-value","onChange","loading"])]),_:1}),l(C,{prop:"created_at",label:"创建时间",width:"160"},{default:n(({row:s})=>[r(d(J(s.created_at)),1)]),_:1}),l(C,{prop:"updated_at",label:"更新时间",width:"160"},{default:n(({row:s})=>[r(d(J(s.updated_at)),1)]),_:1}),l(C,{label:"操作",width:"180",fixed:"right"},{default:n(({row:s})=>[a("div",mt,[l(c,{type:"primary",size:"small",onClick:L=>ge(s)},{default:n(()=>[l(i,null,{default:n(()=>[l(u(Be))]),_:1}),e[20]||(e[20]=r(" 编辑 ",-1))]),_:1},8,["onClick"]),l(c,{type:"danger",size:"small",onClick:L=>me(s)},{default:n(()=>[l(i,null,{default:n(()=>[l(u(le))]),_:1}),e[21]||(e[21]=r(" 删除 ",-1))]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])),[[Re,u(m).loading]]),a("div",bt,[l(xe,{"current-page":u(m).pagination.page,"onUpdate:currentPage":e[6]||(e[6]=s=>u(m).pagination.page=s),"page-size":u(m).pagination.pageSize,"onUpdate:pageSize":e[7]||(e[7]=s=>u(m).pagination.pageSize=s),"page-sizes":[10,20,50,100],total:u(m).pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:fe,onCurrentChange:ve},null,8,["current-page","page-size","total"])])])):(h(),x("div",yt,[l(Ce,{description:"请先选择要管理的客户端"},{image:n(()=>[l(i,{size:"100",color:"#ccc"},{default:n(()=>[l(u(ee))]),_:1})]),_:1})])),l(Se,{modelValue:R.value,"onUpdate:modelValue":e[13]||(e[13]=s=>R.value=s),title:$.value?"编辑路由":"新建路由",width:"600px","before-close":G},{footer:n(()=>[a("div",Vt,[l(c,{onClick:G},{default:n(()=>[...e[53]||(e[53]=[r("取消",-1)])]),_:1}),l(c,{type:"primary",onClick:_e,loading:N.value},{default:n(()=>[r(d($.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:n(()=>[l(Ve,{ref_key:"routeFormRef",ref:T,model:p.value,rules:se,"label-width":"120px"},{default:n(()=>[l(U,{label:"关联客户端"},{default:n(()=>[l(V,{value:oe(),readonly:"",style:{width:"100%"}},{suffix:n(()=>[l(o,{type:Q()==="online"?"success":"warning",size:"small"},{default:n(()=>[r(d(Q()==="online"?"在线":"离线"),1)]),_:1},8,["type"])]),_:1},8,["value"]),e[22]||(e[22]=a("div",{class:"form-tip"}," 只能选择在线的客户端 ",-1))]),_:1}),l(U,{label:"服务器路径",prop:"url_suffix"},{default:n(()=>[l(V,{modelValue:p.value.url_suffix,"onUpdate:modelValue":e[8]||(e[8]=s=>p.value.url_suffix=s),placeholder:"例如: /api/v1/users 或 /api/*/users 或 /api/**/users"},{prepend:n(()=>[r(d(A.value),1)]),_:1},8,["modelValue"]),a("div",wt,[r(" 完整访问地址: "+d(A.value)+d(p.value.url_suffix),1),e[23]||(e[23]=a("br",null,null,-1)),e[24]||(e[24]=a("strong",null,"支持的匹配模式:",-1)),e[25]||(e[25]=a("br",null,null,-1)),e[26]||(e[26]=r(" • 精确匹配: ",-1)),e[27]||(e[27]=a("code",null,"/api/users",-1)),e[28]||(e[28]=r(" - 只匹配 /api/users",-1)),e[29]||(e[29]=a("br",null,null,-1)),e[30]||(e[30]=r(" • 单段通配符: ",-1)),e[31]||(e[31]=a("code",null,"/api/*/users",-1)),e[32]||(e[32]=r(" - 匹配 /api/v1/users, /api/v2/users 等",-1)),e[33]||(e[33]=a("br",null,null,-1)),e[34]||(e[34]=r(" • 段内通配符: ",-1)),e[35]||(e[35]=a("code",null,"/api/user*",-1)),e[36]||(e[36]=r(" - 匹配 /api/users, /api/user123 等",-1)),e[37]||(e[37]=a("br",null,null,-1)),e[38]||(e[38]=r(" • 双通配符: ",-1)),e[39]||(e[39]=a("code",null,"/api/**/users",-1)),e[40]||(e[40]=r(" - 匹配 /api/users, /api/v1/users, /api/v1/v2/users 等",-1)),e[41]||(e[41]=a("br",null,null,-1)),e[42]||(e[42]=r(" • 前缀匹配: ",-1)),e[43]||(e[43]=a("code",null,"/api/*",-1)),e[44]||(e[44]=r(" - 匹配所有以 /api/ 开头的路径",-1)),e[45]||(e[45]=a("br",null,null,-1)),e[46]||(e[46]=r(" • 后缀匹配: ",-1)),e[47]||(e[47]=a("code",null,"*/users",-1)),e[48]||(e[48]=r(" - 匹配所有以 /users 结尾的路径 ",-1))])]),_:1}),l(U,{label:"路由配置模式",prop:"route_mode"},{default:n(()=>[l(y,{modelValue:p.value.route_mode,"onUpdate:modelValue":e[9]||(e[9]=s=>p.value.route_mode=s),placeholder:"选择路由模式",style:{width:"100%"}},{default:n(()=>[l(_,{label:"基础模式",value:"basic"},{default:n(()=>[...e[49]||(e[49]=[a("div",null,[a("div",null,"基础模式"),a("div",{style:{"font-size":"12px",color:"#999"}},"仅配置目的IP:PORT，自动匹配原始请求的URL后缀路径")],-1)])]),_:1}),l(_,{label:"完整模式",value:"full"},{default:n(()=>[...e[50]||(e[50]=[a("div",null,[a("div",null,"完整模式"),a("div",{style:{"font-size":"12px",color:"#999"}},"配置固定完整URL地址的路由转发")],-1)])]),_:1})]),_:1},8,["modelValue"]),e[51]||(e[51]=a("div",{class:"form-tip"},[a("strong",null,"基础模式"),r("：目标地址格式为 http://ip:port，请求时自动拼接原始URL路径"),a("br"),a("strong",null,"完整模式"),r("：目标地址为完整URL，请求时直接转发到指定地址 ")],-1))]),_:1}),l(U,{label:"目标地址",prop:"targets_json"},{default:n(()=>[l(V,{modelValue:p.value.targets_json,"onUpdate:modelValue":e[10]||(e[10]=s=>p.value.targets_json=s),placeholder:p.value.route_mode==="basic"?"例如: 192.168.1.100:8080":"例如: http://192.168.1.100:8080/api/v1"},null,8,["modelValue","placeholder"]),a("div",ht,[p.value.route_mode==="basic"?(h(),x("span",xt," 基础模式：仅需配置IP和端口，系统会自动拼接原始请求路径 ")):(h(),x("span",Ct," 完整模式：配置完整的目标URL地址 "))])]),_:1}),l(U,{label:"启用状态"},{default:n(()=>[l(X,{modelValue:p.value.enabled,"onUpdate:modelValue":e[11]||(e[11]=s=>p.value.enabled=s),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"]),e[52]||(e[52]=a("div",{class:"form-tip"}," 禁用的路由不会处理请求转发 ",-1))]),_:1}),l(U,{label:"描述"},{default:n(()=>[l(V,{modelValue:p.value.description,"onUpdate:modelValue":e[12]||(e[12]=s=>p.value.description=s),type:"textarea",rows:3,placeholder:"路由描述（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Bt=Ee(St,[["__scopeId","data-v-e96997ca"]]);export{Bt as default};
